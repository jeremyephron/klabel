<!DOCTYPE html>
<html>
<head>
	<title>KLabeler Labeling Function Viz</title>
<style>
	body {
		font-family: Helvetica, Arial, sans-seris;
		font-size: 10pt;
		color: #c0c0c0;
		background: #404040;
	}

	body a {
		color: #d0d0d0;
	}

	.bold_text {
		font-weight: bold;
	}
</style>

<script src="kmath.js"></script>
<script>

	class KLFViz {

		constructor() {

			this.main_canvas_el = null;

			this.cursorx = Number.MIN_SAFE_INTEGER;
			this.cursory = Number.MIN_SAFE_INTEGER;

			this.data_matrix = null;
			this.num_rows = 0;
			this.num_lf = 0;

			// color constants
			this.color_main_canvas = '#c0c0c0';
			this.color_lf_positive = '#67bf5c';
			this.color_lf_negative = '#ed665d';
			this.color_lf_abstain = '#a2a2a2';
			this.color_highlight_box_outline = 'rgba(255, 255, 255, 0.6)';


			// layout parameters
			this.display_el_width = 8;
			this.display_el_height = 8;
			this.display_col_sep = 8;

		}

		handle_canvas_mousemove = event => {
			this.set_canvas_cursor_position(event.offsetX, event.offsetY);
			this.render();
		}

		handle_canvas_mouseover = event => {
			this.set_canvas_cursor_position(event.offsetX, event.offsetY);		
			this.render();
		}

		handle_canvas_mouseout = event => {
			this.cursorx = Number.MIN_SAFE_INTEGER;
			this.cursory = Number.MIN_SAFE_INTEGER;
			this.render();
		}

		init(main_canvas_el) {

			console.log("KLFViz: initializing...");
			this.main_canvas_el = main_canvas_el;

			this.main_canvas_el.addEventListener("mousemove", this.handle_canvas_mousemove, false);
			this.main_canvas_el.addEventListener("mouseover", this.handle_canvas_mouseover, false);
			this.main_canvas_el.addEventListener("mouseout", this.handle_canvas_mouseout, false);

			this.render();
		}

		// true if the mouse is hovering over the canvas
		is_hovering() {
			return (this.cursorx >= 0 && this.cursory >= 0);
		}

		// Clamp the cursor to the image dimensions so that clicks,
		// and (resulting bounding boxes) are always within the image
		set_canvas_cursor_position(x,y) {
			this.cursorx = clamp(x, 0, this.main_canvas_el.width);
			this.cursory = clamp(y, 0, this.main_canvas_el.height);	
		}

		render() {
			var ctx = this.main_canvas_el.getContext('2d');

			ctx.fillStyle = this.color_main_canvas;
			ctx.fillRect(0, 0, this.main_canvas_el.width, this.main_canvas_el.height);

			var rows_per_col = Math.floor(this.main_canvas_el.height / this.display_el_height);
			var num_cols = Math.floor((this.num_rows + rows_per_col - 1) / rows_per_col); 

			//console.log("Height=" + this.main_canvas_el.height + ", data_per_col=" + rows_per_col + ", num_cols=" + num_cols); 

			for (var col=0; col<num_cols; col++) {

				var start_row = col * rows_per_col;
				var end_row = Math.min(start_row + rows_per_col, this.num_rows);
				var rows_in_this_col = end_row - start_row;

				// now draw a column of data points
				for (var i=0; i<rows_in_this_col; i++) {
					var start_y = i*this.display_el_height;

					for (var j=0; j<this.num_lf; j++) {
						var idx = (start_row + i)*this.num_lf + j;

						var el_color = this.color_lf_abstain;
						if (this.data_matrix[idx] == 1)
							el_color = this.color_lf_positive;
						else if (this.data_matrix[idx] == -1)
							el_color = this.color_lf_negative;

						var start_x = col * (this.display_el_width * this.num_lf + this.display_col_sep) + j*this.display_el_width;
						ctx.fillStyle = el_color;
						ctx.fillRect(start_x, start_y, this.display_el_width, this.display_el_height);
					}
				}
			}

			if (this.is_hovering()) {

				// check to see if cursor is hovering over any datapoint row
				// if so highlight it

				// first get the row
				var row = Math.floor(this.cursory / this.display_el_height);

				// then get the column
				var spaced_col_width = this.display_el_width*this.num_lf + this.display_col_sep;
				var col = Math.floor(this.cursorx / spaced_col_width);

				// compute datapoint index
				var rows_per_col = Math.floor(this.main_canvas_el.height / this.display_el_height);
				var datapoint = col * rows_per_col + row;

				// draw the highlight
				if (datapoint < this.num_rows) {

					ctx.lineWidth = 1;
					ctx.strokeStyle = this.color_highlight_box_outline;
		
					ctx.strokeRect(col*spaced_col_width, row*this.display_el_height,
					    		   this.display_el_width*this.num_lf, this.display_el_height);
				}

			}
		}

		load_data(num_rows, num_lf, matrix) {
			this.num_rows = num_rows;
			this.num_lf = num_lf;
			this.data_matrix = matrix;

			console.log("KLFViz: loading data (num rows=" + this.num_rows + ", num lf=" + this.num_lf + ")");
			this.render();
		}
	}

	var main_canvas_id = 'main_canvas';   // this is the DOM canvas element 
	var lfviz = new KLFViz;

	function handle_onload() {

		var num_rows = 1024;
		var num_lf = 5;
		var data = [];
		for (var i = 0; i<num_rows; i++) {
			for (var j=0; j<num_lf; j++) {

				var x = Math.random();

				if (x < 1.0/5.0 )
					data[i*num_lf + j] = 1;
				else if (x < 2.0/5.0)
					data[i*num_lf + j] = -1;
				else
					data[i*num_lf + j] = 0;
			}
		}

		var main_canvas = document.getElementById(main_canvas_id);
		lfviz.init(main_canvas);
		lfviz.load_data(num_rows, num_lf, data);
	}

</script>
</head>

<body onload="handle_onload()">

<div id="labeled_div">
	<canvas id="main_canvas" width="960" height="500" style="border: 1px solid #c0c0c0;" ></canvas>
</div>
<div>Highlight data points where 
	<select id="select_lf" onchange="">
       <option value="lf_all">all labels funcs</option>
       <option value="lf_any">any labeling func</option>
    </select>
    <select id="select_lf_status" onchange="">
       <option value="positive">vote positive</option>
       <option value="negative">vote negative</option>
       <option value="abstain">abstain</option>
       <option value="abstain">disagrees</option>
    </select>
    .
</div>
<div id="hover_status"></div>
</body>
</html>